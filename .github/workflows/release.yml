name: Release

on:
  push:
    tags:
      - 'v*.*.*'  # åŒ¹é… v0.3.0ã€v1.0.0 ç­‰è¯­ä¹‰åŒ–ç‰ˆæœ¬ tag

permissions:
  contents: write  # å…è®¸åˆ›å»º GitHub Release

env:
  NODE_VERSION: '20'
  PNPM_VERSION: '9'

jobs:
  # â”€â”€â”€ åˆ›å»º GitHub Release â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # è·å–å®Œæ•´å†å²ï¼Œç”¨äºç”Ÿæˆ Changelog

      - name: Extract version from tag
        id: version
        run: |
          TAG=${GITHUB_REF#refs/tags/}
          VERSION=${TAG#v}
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"

      - name: Extract changelog for this version
        id: changelog
        run: |
          VERSION=${{ steps.version.outputs.version }}

          # ä» CHANGELOG.md æå–å½“å‰ç‰ˆæœ¬çš„å˜æ›´è®°å½•
          # æ ¼å¼ï¼š## [X.Y.Z] - YYYY-MM-DD ... ## [X.Y.Z-1] ...
          CHANGELOG=$(awk "/^## \[$VERSION\]/,/^## \[/" CHANGELOG.md \
            | head -n -1 \
            | tail -n +2 \
            | sed 's/^### /### /' \
          )

          if [ -z "$CHANGELOG" ]; then
            CHANGELOG="è¯·æŸ¥çœ‹ [CHANGELOG.md](https://github.com/${{ github.repository }}/blob/main/CHANGELOG.md) äº†è§£è¯¦ç»†å˜æ›´ã€‚"
          fi

          # å¤šè¡Œè¾“å‡ºéœ€è¦ä½¿ç”¨ EOF åˆ†éš”ç¬¦
          echo "content<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGELOG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build production
        run: pnpm build
        env:
          NODE_ENV: production
          DATABASE_URL: postgresql://placeholder:placeholder@localhost:5432/archmind
          JWT_SECRET: placeholder-build-secret

      - name: Generate OpenAPI docs
        run: pnpm docs:api

      - name: Create release archive
        run: |
          mkdir -p release-artifacts
          # æ‰“åŒ…æ„å»ºäº§ç‰©
          tar -czf release-artifacts/archmind-${{ steps.version.outputs.tag }}-build.tar.gz .output/
          # æ‰“åŒ… OpenAPI æ–‡æ¡£
          cp docs/api/openapi.json release-artifacts/openapi-${{ steps.version.outputs.tag }}.json

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          name: "ArchMind ${{ steps.version.outputs.tag }}"
          body: |
            ## ArchMind ${{ steps.version.outputs.tag }}

            ${{ steps.changelog.outputs.content }}

            ---

            ### å¿«é€Ÿå¼€å§‹

            ```bash
            # Docker ä¸€é”®å¯åŠ¨
            docker pull ghcr.io/${{ github.repository }}:${{ steps.version.outputs.tag }}
            docker compose up -d
            ```

            ### ä¸‹è½½å†…å®¹

            | æ–‡ä»¶ | è¯´æ˜ |
            |------|------|
            | `archmind-${{ steps.version.outputs.tag }}-build.tar.gz` | Nuxt æ„å»ºäº§ç‰©ï¼ˆ`.output/`ï¼‰ |
            | `openapi-${{ steps.version.outputs.tag }}.json` | OpenAPI 3.0 è§„èŒƒæ–‡æ¡£ |

            ### å‡çº§è¯´æ˜

            è¯·æŸ¥çœ‹ [CHANGELOG.md](https://github.com/${{ github.repository }}/blob/main/CHANGELOG.md#${{ steps.version.outputs.version }}) äº†è§£æ•°æ®åº“è¿ç§»æ­¥éª¤ã€‚
          files: |
            release-artifacts/archmind-${{ steps.version.outputs.tag }}-build.tar.gz
            release-artifacts/openapi-${{ steps.version.outputs.tag }}.json
          draft: false
          prerelease: ${{ contains(steps.version.outputs.tag, '-rc') || contains(steps.version.outputs.tag, '-beta') || contains(steps.version.outputs.tag, '-alpha') }}

      - name: Release summary
        run: |
          echo "## ğŸ‰ Release Created" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ steps.version.outputs.tag }}" >> $GITHUB_STEP_SUMMARY
          echo "**URL:** https://github.com/${{ github.repository }}/releases/tag/${{ steps.version.outputs.tag }}" >> $GITHUB_STEP_SUMMARY
