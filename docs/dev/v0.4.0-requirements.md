# ArchMind v0.4.0 版本需求文档

> 版本目标：提升 PRD 与原型的生成质量，完善产品体验闭环
>
> 基线版本：v0.3.0（已发布）
> 目标版本：v0.4.0
> 文档状态：已定稿（v1.1）
> 最后更新：2026-03-01

---

## 一、版本目标

v0.3.0 完成了实时协作、Webhook、OpenAPI 等基础设施建设。v0.4.0 的重心转回**核心产品力**，聚焦于提升 AI 生成文档与原型的质量和用户体验，具体体现在三个方向：

1. **PRD 生成质量**：扩展示例库、优化上下文利用、建立质量反馈闭环
2. **原型生成质量**：增强解析容错性、丰富交互能力、支持主题定制
3. **RAG 检索质量**：动态阈值调整、检索效果可观测

---

## 二、功能清单

| Issue | 功能名称 | 模块 | 优先级 |
|-------|----------|------|--------|
| #51 | Few-shot 示例库扩展（10+ 行业） | PRD 生成 | P0 |
| #52 | 语义感知上下文压缩 | PRD 生成 | P0 |
| #53 | PRD 质量自评维度扩展 | PRD 生成 | P1 |
| #54 | PRD 用户反馈打分机制 | PRD 生成 | P1 |
| #55 | 原型多页面解析容错增强 | 原型生成 | P0 |
| #56 | 原型设计主题/色系定制 | 原型生成 | P1 |
| #57 | 原型交互 JS 模板库 | 原型生成 | P0 |
| #58 | RAG 动态相似度阈值 | RAG 检索 | P1 |
| #59 | 检索质量评估面板 | RAG 检索 | P2 |
| #60 | Webhook 前端管理页面 | 产品体验 | P1 |
| #61 | PRD 多版本对比查看 | 产品体验 | P2 |

> **优先级定义**：P0 = 版本必做；P1 = 强烈建议；P2 = 时间充裕时实现

---

## 三、功能详细说明

---

### #51 Few-shot 示例库扩展

**问题**：当前 `lib/ai/prompts/prd-examples.ts` 仅有 3 个示例（电商积分、智能推荐、性能优化），领域覆盖窄，导致非电商类 PRD 缺乏针对性指导。

**目标**：将示例库扩展至 10+ 个，覆盖主流产品类型，使模型在不同场景下都能生成高质量 PRD。

**新增示例行业**：

| 示例编号 | 行业 | 功能场景 |
|----------|------|----------|
| 04 | SaaS B2B | 企业权限管理系统（RBAC） |
| 05 | 教育 | 在线学习进度追踪与证书发放 |
| 06 | 医疗健康 | 用户健康数据看板与预警 |
| 07 | 金融 | 账单分析与智能记账分类 |
| 08 | 内容社区 | 创作者激励体系（打赏/分成） |
| 09 | 工具软件 | 数据导入导出与批量操作 |
| 10 | 政务/企业内部 | 审批流程引擎 |

**示例选择策略优化**：

当前 `selectRelevantExamples()` 为关键词匹配 + 类别权重，优化为**三维匹配**：
1. 行业关键词匹配（B2B/教育/医疗等）
2. 功能类型匹配（管理/分析/社交等）
3. 用户输入语义相似度（embedding 向量距离，可选，有 embedding 适配器时启用）

> **注意**：`buildPRDPrompt()` 已支持接收 `examples?: PRDExample[]` 参数，本功能改动点在示例数量与选择策略，不涉及 prompt 构建接口变更。

**验收标准**：
- [ ] `prd-examples.ts` 包含 10 个以上不同行业示例
- [ ] 每个示例格式与现有示例一致（包含 KPI、边界条件、用户流程）
- [ ] 示例选择算法能根据用户输入的行业关键词命中对应示例
- [ ] 现有单元测试通过，新增示例选择的测试用例

---

### #52 语义感知上下文压缩

**问题**：当前 `PRDGenerator.compressContext()` 按 `\n---\n` 分割文档块，超出 Token 预算时简单截取首尾 500 字，可能丢弃重要的业务逻辑段落。

**目标**：改为按 Markdown 标题语义分块，基于内容重要性打分后优先保留高价值段落。

**现有逻辑**：
```
sections = context.split('\n---\n')
超出时：保留 section 的前 500字 + '...' + 后 500字
```

**优化逻辑**：

```
1. 按 Markdown 标题（##、###）将文档拆成语义段落
2. 对每个段落打重要性分（0~1）：
   - 段落标题包含关键词（功能、需求、用户、目标）→ +0.3
   - 段落含数据/指标（数字、%、KPI）→ +0.2
   - 段落长度适中（100~500字）→ +0.1
3. 按分数降序填充，直到达到 Token 预算上限
4. 按原文顺序重新排列选中段落后拼接输出
```

**Token 预算调整**：

| 项目 | 当前 | 优化后 | 说明 |
|------|------|--------|------|
| RAG 上下文 | 4000 tokens | 5000 tokens | 压缩质量提升，可给更多空间 |
| Few-shot 示例 | 2000 tokens | 1500 tokens | 精简示例，匀出空间给上下文 |
| 系统提示 | 1500 tokens | 1500 tokens | 不变 |
| 用户输入 | 500 tokens | 500 tokens | 不变 |

> **影响范围**：仅修改 `PRDGenerator` 内的 `compressContext()` 和 `allocateTokenBudget()`，不影响对外接口。

**验收标准**：
- [ ] 压缩后的上下文优先包含含有数据指标的段落
- [ ] 压缩结果可读性正常（无中途截断的句子）
- [ ] 单元测试覆盖：全量上下文、超预算压缩、仅有一段的边界情况

---

### #53 PRD 质量自评维度扩展

**问题**：`lib/prd/refinement-engine.ts` 的 AI 自评只有 4 个维度（完整性/具体性/逻辑自洽/KPI 质量），缺少对创新性和可行性的判断，导致迭代优化方向偏窄。

**目标**：新增 2 个评估维度，提升优化精准度。

**新增维度**：

| 维度 | 评估标准 | 权重 |
|------|----------|------|
| **可行性** (feasibility) | 技术方案是否脱离实际？实施计划时间线是否合理？资源需求是否有估算？ | 15% |
| **用户视角** (userFocus) | 用户故事是否从真实场景出发？功能描述是否从用户利益而非技术角度阐述？ | 15% |

**调整后各维度权重**：

| 维度 | 权重 |
|------|------|
| completeness（完整性） | 25% |
| specificity（具体性） | 20% |
| logicalConsistency（逻辑自洽） | 15% |
| kpiQuality（KPI 质量） | 10% |
| feasibility（可行性）🆕 | 15% |
| userFocus（用户视角）🆕 | 15% |

**质量阈值调整**：迭代触发阈值从 0.85 下调为 0.80（维度增加后达到高分更难，避免过度迭代）。

**验收标准**：
- [ ] `refinement-engine.ts` AI 自评 prompt 包含新维度
- [ ] 解析逻辑能处理新增字段
- [ ] 当 feasibility < 0.6 时，issues 中包含具体的可行性问题描述
- [ ] 单元测试更新，覆盖新维度的评分解析

---

### #54 PRD 用户反馈打分机制

**问题**：用户生成 PRD 后没有评价入口，生成质量好坏完全不可见，无法驱动 prompt 持续优化。

**目标**：在 PRD 详情页添加轻量打分入口，将反馈数据存入数据库，为后续 prompt 优化提供依据。

**前端位置**：`pages/projects/[id].vue`（PRD 详情页底部，内容渲染区之后）

**交互设计**：

```
PRD 详情页底部

[  ⭐⭐⭐⭐⭐  这份 PRD 对你有帮助吗？  ]
                    ↓ 点击星级后展开
[  好的方面（可多选）  ][  需要改进（可多选）  ]
□ 结构清晰    □ 内容空泛
□ KPI 具体    □ 缺少数据支撑
□ 行业符合    □ 技术方案不实际
□ 可直接使用  □ 需要大量修改
           [ 提交反馈 ]
```

**数据结构**：

```sql
-- 新增表：prd_feedbacks
CREATE TABLE prd_feedbacks (
  id          UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  prd_id      UUID NOT NULL REFERENCES prd_documents(id) ON DELETE CASCADE,
  user_id     UUID NOT NULL REFERENCES users(id),
  rating      SMALLINT NOT NULL CHECK (rating BETWEEN 1 AND 5),
  positives   TEXT[],   -- 好的方面标签
  negatives   TEXT[],   -- 需改进标签
  comment     TEXT,     -- 可选的文字说明
  created_at  TIMESTAMPTZ DEFAULT NOW(),
  UNIQUE(prd_id, user_id)  -- 每个用户对每份 PRD 只能有一条反馈
);
```

**API 端点**：

| 方法 | 路径 | 说明 |
|------|------|------|
| POST | `/api/v1/prd/:id/feedback` | 提交或更新反馈（upsert） |
| GET  | `/api/v1/prd/:id/feedback` | 获取当前用户的反馈（用于回显） |
| GET  | `/api/v1/stats/prd-quality` | 工作区维度的质量统计（平均分、差评标签分布） |

> **注意**：`/api/v1/stats/` 下目前只有 `index.get.ts`（返回文档数/PRD数/向量数），新增 `prd-quality.get.ts` 为新文件，不影响现有端点。

**验收标准**：
- [ ] PRD 详情页底部显示打分组件（未评分状态 / 已评分回显状态）
- [ ] 5 星评分 + 多选标签 + 可选文字，一次性提交
- [ ] 同一用户对同一 PRD 只能提交一次（再次点击为修改，使用 upsert）
- [ ] `settings/profile.vue` 新增「数据统计」Tab 展示平均分趋势图
- [ ] 数据库迁移脚本 `migrations/add-prd-feedbacks.sql`

---

### #55 原型多页面解析容错增强

**问题**：`PrototypeGenerator.parseMultiPageOutput()` 使用正则 `/<!-- PAGE:(\w[\w-]*):(.+?) -->/g` 识别页面分隔标记，AI 偶发不遵循格式时会解析失败，导致原型生成为空或整体作为单页。

**目标**：建立多层容错解析策略，将原型生成成功率提升至 95% 以上。

**多层解析策略**：

```
层级 1（主路径）：识别 <!-- PAGE:slug:名称 --> 标记，按标记切分页面
        ↓ 失败
层级 2（容错）：识别 <h1> 或 <title> 标签，尝试按 HTML 文档边界拆分
        ↓ 失败
层级 3（降级）：识别 ```html 代码块，提取所有代码块作为独立页面
        ↓ 失败
层级 4（兜底）：将整个输出作为单页面，截取 <!DOCTYPE> 到 </html>
```

**页面元数据补全**：

当解析层级 ≥ 2 时，自动从 HTML 内容推断缺失的元数据：
- slug：从 `<title>` 标签提取，转为 kebab-case，或生成 `page-{n}`
- 名称：从 `<h1>` 或 `<title>` 提取，或使用「页面 N」

**验收标准**：
- [ ] 单元测试覆盖 4 种解析层级（含各层失败降级）
- [ ] 标记格式错误（大小写、多余空格）时能正确解析
- [ ] 解析结果中每个页面都有有效的 slug 和名称
- [ ] 解析失败时记录 warn 日志，包含失败原因和使用的降级层级

---

### #56 原型设计主题/色系定制

**问题**：`lib/prototype/prototype-system.ts` 中设计系统硬编码 `Primary: #6366F1`，所有原型视觉风格高度相似，缺乏品牌适配能力。

**目标**：允许用户在生成原型时选择或自定义主色调，原型设计系统随之调整。

**主题预设**：

| 主题名 | Primary | 风格定位 |
|--------|---------|----------|
| 默认紫（Default） | #6366F1 | 现代 SaaS |
| 科技蓝（Tech） | #2563EB | 企业/政务 |
| 自然绿（Nature） | #059669 | 健康/教育 |
| 活力橙（Energy） | #EA580C | 电商/消费 |
| 专业灰（Pro） | #374151 | 工具/效率 |
| 自定义（Custom） | 用户输入 HEX | 品牌定制 |

**实现方式**：

在系统提示词中将颜色定义参数化：

```typescript
function buildDesignSystem(theme: ThemeConfig): string {
  return `
## 设计系统
- Primary: ${theme.primary}       // 主操作色
- Primary-light: ${theme.primaryLight}  // 自动计算 lighter 20%
- Primary-dark: ${theme.primaryDark}   // 自动计算 darker 20%
  `
}
```

**API 变更**：

`POST /api/v1/prototypes/generate-from-prd` 新增可选字段（该端点现有参数为 `prdId`、`modelId`、`temperature`、`maxTokens`、`pageCount`、`deviceType`）：

```typescript
{
  theme?: {
    preset: 'default' | 'tech' | 'nature' | 'energy' | 'pro' | 'custom',
    primaryColor?: string  // 仅 preset='custom' 时有效，格式 #RRGGBB
  }
}
```

**前端入口**：

原型生成对话框中新增「主题」选择行，展示色块预览，默认选中「默认紫」。

**验收标准**：
- [ ] 6 种预设主题，色块在 UI 中可点选
- [ ] 自定义模式支持 HEX 颜色输入，实时预览色块
- [ ] 生成的 HTML 中 Tailwind 颜色替换为对应主题色（通过 CSS 变量或内联样式）
- [ ] 主题选择保存至 prototype 记录，重新生成时默认沿用

---

### #57 原型交互 JS 模板库

**问题**：原型的 JavaScript 交互逻辑完全依赖模型生成，质量不稳定，常见交互（Modal、Tab 切换、表单验证、下拉菜单）经常出现逻辑错误或样式异常。

**目标**：预置一套经过测试的常用交互 JS 片段，注入系统提示词，替代模型自由生成。

**模板库内容**：

| 模板名 | 功能描述 |
|--------|----------|
| `modal` | 弹窗打开/关闭，点击遮罩关闭，ESC 关闭 |
| `tabs` | Tab 切换，active 样式联动 |
| `dropdown` | 下拉菜单展开/收起，点击外部关闭 |
| `form-validate` | 必填校验，错误提示显示/隐藏 |
| `toast` | 轻提示，3 秒后自动消失，支持 success/error 类型 |
| `accordion` | 手风琴折叠展开 |
| `sidebar-toggle` | 侧边栏折叠，移动端汉堡菜单 |
| `table-sort` | 表格列点击排序 |
| `infinite-scroll` | 滚动到底部触发加载更多 |
| `search-filter` | 输入框实时过滤列表 |

**注入方式**：

在系统提示词的「JavaScript 规范」章节中，追加常用交互的标准实现代码块，并要求模型直接使用这些实现，不要重新创造。

**验收标准**：
- [ ] `prototype-system.ts` 中包含完整的 10 个 JS 模板
- [ ] 每个模板经过人工测试验证功能正确
- [ ] 模板以内联 `<script>` 格式编写，无外部依赖
- [ ] 生成 3 个原型样本，对比加入模板前后的交互质量

---

### #58 RAG 动态相似度阈值

**问题**：`lib/rag/retriever.ts` 固定使用 `threshold = 0.7`，对短查询（如"登录"）过于宽松引入噪声，对长查询（如"用户在未登录状态下访问受保护页面的处理逻辑"）又可能过于严格导致召回不足。

**目标**：根据查询特征动态计算相似度阈值，提升检索精准度。

**动态阈值规则**：

```typescript
function computeThreshold(query: string): number {
  const tokenCount = query.length / 4  // 粗估 token 数

  let threshold = 0.70  // 基准阈值

  // 短查询（< 5 tokens）：语义模糊，放宽阈值避免召回过少
  if (tokenCount < 5) threshold -= 0.05

  // 长查询（> 20 tokens）：语义明确，收紧阈值减少噪声
  if (tokenCount > 20) threshold += 0.05

  // 含有专有名词（全大写词、英文缩写）：精确匹配更重要
  if (/\b[A-Z]{2,}\b/.test(query)) threshold += 0.03

  // 纯中文短查询：中文embedding距离分布偏低，适当放宽
  if (/^[\u4e00-\u9fa5\s]+$/.test(query) && tokenCount < 10) threshold -= 0.03

  return Math.min(Math.max(threshold, 0.55), 0.85)  // 限制在 [0.55, 0.85]
}
```

**配置化支持**：

允许工作区级别覆盖动态阈值策略，在工作区设置中提供「检索精度」滑块（宽泛 ↔ 精准），映射为 baseThreshold 偏移量（-0.1 ~ +0.1）。

**验收标准**：
- [ ] `RAGRetriever.retrieve()` 调用 `computeThreshold()` 替代硬编码 0.7
- [ ] 阈值计算有单元测试覆盖（短/长/中文/含缩写 4 种情况）
- [ ] 新增可选参数 `thresholdOverride` 允许调用方强制指定阈值（向后兼容）
- [ ] 检索结果日志中记录实际使用的阈值值

---

### #59 检索质量评估面板

**问题**：RAG 检索效果完全不可观测，不知道哪些文档被引用、引用质量如何，用户无法判断知识库是否在发挥作用。

**目标**：在工作区文档管理页面新增「检索统计」Tab，展示文档被引用情况和检索质量指标。

**展示内容**：

```
检索统计                          时间范围: [最近7天 ▾]

总检索次数          引用文档数        平均相似度         命中率
    128               23               0.76             87%

热门引用文档
┌─────────────────────────────┬──────┬──────────┐
│ 文档名称                     │ 引用次数 │ 平均相似度 │
├─────────────────────────────┼──────┼──────────┤
│ 产品需求说明书 v2.pdf         │  34  │  0.82    │
│ 用户调研报告 2025Q4.docx      │  28  │  0.79    │
│ 竞品分析文档.md               │  15  │  0.74    │
└─────────────────────────────┴──────┴──────────┘

低命中文档（可能需要重新上传或补充内容）
• API 设计规范 v1.0.pdf — 最近 7 天 0 次引用
```

**数据收集**：

在 `RAGRetriever.retrieve()` 返回结果时，异步写入检索日志表：

```sql
CREATE TABLE rag_retrieval_logs (
  id            UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  workspace_id  UUID NOT NULL,
  user_id       UUID NOT NULL,
  query_hash    TEXT NOT NULL,          -- SHA256 of query（不存明文）
  document_ids  UUID[],                 -- 被引用的文档 ID 列表
  similarity_scores FLOAT[],            -- 对应的相似度分数
  strategy      TEXT,                   -- 'vector' | 'hybrid'
  threshold     FLOAT,
  result_count  INTEGER,
  created_at    TIMESTAMPTZ DEFAULT NOW()
);
```

**验收标准**：
- [ ] 文档管理页面新增「检索统计」Tab
- [ ] 展示总次数、引用文档数、平均相似度、命中率 4 个核心指标
- [ ] 热门引用文档 Top 10 表格，可按引用次数/相似度排序
- [ ] 零引用文档单独列出，提示用户检查文档质量
- [ ] 数据库迁移脚本 `migrations/add-rag-retrieval-logs.sql`
- [ ] 检索日志写入为异步操作，不影响主链路性能

---

### #60 Webhook 前端管理页面

**问题**：v0.3.0 已完整实现 Webhook 后端 API，但没有对应的前端管理界面，用户只能通过 API 工具管理 Webhook。

**实际 API 路径**（需与文档对齐，非 `/api/v1/webhooks/*`）：

| 方法 | 实际路径 | 说明 |
|------|----------|------|
| GET  | `/api/v1/workspaces/:id/webhooks` | 获取列表 |
| POST | `/api/v1/workspaces/:id/webhooks` | 创建 |
| PATCH | `/api/v1/workspaces/:id/webhooks/:wid` | 编辑 |
| DELETE | `/api/v1/workspaces/:id/webhooks/:wid` | 删除 |
| GET  | `/api/v1/workspaces/:id/webhooks/:wid/deliveries` | 投递历史 |

> ⚠️ **重新投递接口缺失**：当前后端没有 redelivery 端点，「重新投递」功能需要同步新增 `POST /api/v1/workspaces/:id/webhooks/:wid/deliveries/:deliveryId/redeliver`，否则前端该按钮无法实现。

**目标**：新建工作区设置页面，在其中包含 Webhook 管理 Tab，支持创建、编辑、删除和查看投递历史。

**页面位置**：新建 `pages/workspace/[id]/settings.vue`，保持与 `pages/settings/profile.vue` Tab 风格一致。侧边栏工作区切换器中增加「工作区设置」入口。

**功能列表**：

1. **Webhook 列表**

```
Webhook 订阅                              [+ 新建 Webhook]

┌──────────────────────────────┬──────────────┬────────┬────────┐
│ URL                          │ 订阅事件      │ 状态   │ 操作   │
├──────────────────────────────┼──────────────┼────────┼────────┤
│ https://example.com/hook     │ 3 个事件      │ ● 启用 │ 编辑 删除│
│ https://notify.myapp.com     │ 1 个事件      │ ○ 禁用 │ 编辑 删除│
└──────────────────────────────┴──────────────┴────────┴────────┘
```

2. **创建/编辑 Webhook（Dialog）**

```
URL *            [https://your-endpoint.com/webhook  ]
Secret           [可选，用于验证签名                   ]
订阅事件 *        □ document.uploaded
                 □ document.completed
                 □ prd.generated
                 □ comment.created
                 □ member.joined
状态             [● 启用  ○ 禁用]

                        [ 取消 ]  [ 保存 ]
```

3. **投递历史（侧抽屉或子页面）**

```
投递历史 — https://example.com/hook

┌──────────────────────┬─────────────────┬──────┬──────┐
│ 时间                 │ 事件             │ 状态  │ 耗时  │
├──────────────────────┼─────────────────┼──────┼──────┤
│ 03-01 14:23:05       │ prd.generated   │ ✓ 200 │ 234ms│
│ 03-01 14:20:11       │ document.completed│ ✗ 500│ 10s  │
└──────────────────────┴─────────────────┴──────┴──────┘

点击行 → 展开请求体 / 响应体
                              [ 重新投递 ]
```

**验收标准**：
- [ ] 新增 `pages/workspace/[id]/settings.vue`，侧边栏有「工作区设置」入口
- [ ] Webhook Tab：列表展示 URL、事件数、启用状态
- [ ] 创建/编辑使用 Dialog 组件，表单含 URL 必填校验（`z.string().url()`）
- [ ] 删除操作使用 AlertDialog 二次确认
- [ ] 投递历史支持展开查看请求/响应详情（JSON 格式化展示）
- [ ] 新增后端 `POST .../deliveries/:deliveryId/redeliver` 端点，前端「重新投递」按钮调用此端点
- [ ] 全部使用 shadcn/ui 组件，不使用浏览器原生弹窗

---

### #61 PRD 多版本对比查看

**问题**：用户对同一需求多次生成 PRD 时，只能逐一切换查看，无法直观对比不同版本之间的内容差异。

**目标**：在 PRD 列表页支持选中两个版本并排对比，高亮差异内容。

**交互流程**：

```
PRD 列表页
→ 选择模式：列表右上角「对比」按钮进入选择模式
→ 勾选 2 个 PRD → 「开始对比」按钮激活
→ 跳转到对比页面：左右两栏并排展示，差异段落高亮
```

**对比页面布局**：

```
┌─────────── PRD A ───────────┬─────────── PRD B ───────────┐
│ 用户注册功能需求 v1          │ 用户注册功能需求 v2           │
│ 生成于 2026-02-20            │ 生成于 2026-03-01            │
├─────────────────────────────┼─────────────────────────────┤
│ ## 产品概述                 │ ## 产品概述                  │
│ 本产品旨在...               │ 本产品旨在...                 │
├──────── 差异段落 ───────────┤                              │
│ [- 支持邮箱注册]            │ [+ 支持邮箱/手机号双模式注册] │
│ [- KPI: 注册转化率 > 60%]   │ [+ KPI: 注册转化率 > 75%]   │
└─────────────────────────────┴─────────────────────────────┘
```

**差异算法**：使用 `diff-match-patch` 库，按段落级别（Markdown 章节）比对，而非逐字符 diff。

**验收标准**：
- [ ] PRD 列表页支持「对比模式」，最多选 2 个
- [ ] 对比页面左右并排展示，支持同步滚动
- [ ] 差异内容用绿色（新增）/ 红色（删除）高亮
- [ ] 可从对比页面直接跳转到各自 PRD 详情
- [ ] 安装 `diff-match-patch` 依赖

---

## 四、数据库变更汇总

| Issue | 变更类型 | 说明 |
|-------|----------|------|
| #54 | 新增表 | `prd_feedbacks`（PRD 用户反馈，含唯一约束 prd_id+user_id） |
| #59 | 新增表 | `rag_retrieval_logs`（检索日志） |

所有迁移文件放在 `migrations/` 目录，命名格式：`add-{功能描述}.sql`。

---

## 五、API 变更汇总

| Issue | 方法 | 路径 | 说明 |
|-------|------|------|------|
| #54 | POST | `/api/v1/prd/:id/feedback` | 提交或更新 PRD 反馈（upsert） |
| #54 | GET  | `/api/v1/prd/:id/feedback` | 获取当前用户的反馈（回显用） |
| #54 | GET  | `/api/v1/stats/prd-quality` | PRD 质量统计（新文件，不影响现有 stats） |
| #56 | POST | `/api/v1/prototypes/generate-from-prd` | 新增可选 `theme` 字段 |
| #59 | GET  | `/api/v1/stats/rag-retrieval` | RAG 检索统计（新文件） |
| #60 | 全部 | `/api/v1/workspaces/:id/webhooks/*` | 已有，无需修改 |
| #60 | POST | `/api/v1/workspaces/:id/webhooks/:wid/deliveries/:deliveryId/redeliver` | **新增**重新投递端点 |

---

## 六、开发顺序建议

考虑到依赖关系和风险，建议按以下顺序开发：

```
第一阶段（核心引擎优化，无 UI 改动，风险最低）
  #52 语义感知上下文压缩
  #51 Few-shot 示例库扩展
  #57 原型交互 JS 模板库
  #55 原型多页面解析容错
  #58 RAG 动态相似度阈值

第二阶段（质量评估与反馈）
  #53 PRD 质量自评维度扩展
  #54 PRD 用户反馈打分机制
  #59 检索质量评估面板

第三阶段（前端体验扩展）
  #56 原型设计主题定制
  #60 Webhook 前端管理页面
  #61 PRD 多版本对比查看
```

---

## 七、验收总结

v0.4.0 整体验收标准：

- [ ] 所有 P0 功能（#51 #52 #55 #57 #58）实现完毕
- [ ] 所有 P1 功能（#53 #54 #56 #60）实现完毕
- [ ] P2 功能（#59 #61）视进度决定是否纳入
- [ ] 所有新增 API 端点有对应的 Zod 校验
- [ ] 新增数据库表有迁移脚本且经过本地验证
- [ ] 所有 UI 组件使用 shadcn/ui，无浏览器原生弹窗
- [ ] 单元测试覆盖率维持在 85% 以上
- [ ] `pnpm lint` + `pnpm typecheck` + `pnpm test` 全部通过

---

## 八、审阅记录（v1.0 → v1.1）

以下为对初稿（v1.0）的审阅修订记录：

| 类别 | 问题 | 修订内容 |
|------|------|----------|
| **文件路径错误** | #51 写的是 `lib/prd/prd-examples.ts`，实际在 `lib/ai/prompts/prd-examples.ts` | 已更正路径 |
| **接口认知错误** | #60 将 Webhook API 路径写为 `/api/v1/webhooks/*`，实际为 `/api/v1/workspaces/:id/webhooks/*` | 已补充实际路径表格 |
| **功能缺失** | #60「重新投递」后端端点不存在，原文档未标注需要新增 | 已明确标注需新增 `redeliver` 端点 |
| **页面不存在** | #60 写「在工作区设置页面新增 Tab」，但该页面目前不存在 | 已改为「新建 `pages/workspace/[id]/settings.vue`」 |
| **数据库约束遗漏** | #54 `prd_feedbacks` 表缺少唯一约束（同一用户只能评一次） | 已在 DDL 和说明中补充 `UNIQUE(prd_id, user_id)` |
| **接口语义不清** | #54 POST feedback 未说明是否支持修改 | 已明确为 upsert 语义 |
| **影响范围未说明** | #52 未说明改动影响哪些函数和接口 | 已补充影响范围说明 |
| **前端入口未明确** | #54 feedback 组件放在哪个页面未说明 | 已明确为 `pages/projects/[id].vue` |
| **示例文件架构说明不足** | #51 未说明 `buildPRDPrompt()` 已支持 examples 参数，易引发重复实现 | 已补充注意事项 |
| **stats 端点冲突风险** | #54、#59 均新增 stats 子路由，未说明与现有 `stats/index.get.ts` 的关系 | 已补充说明为新文件，不影响现有端点 |

---

*文档版本：v1.1 | 创建日期：2026-03-01 | 审阅日期：2026-03-01 | 负责人：ArchMind Team*
