# ArchMind v0.4.0 开发设计文档

> 基于需求文档 v1.1 编写
> 文档版本：v1.1
> 创建日期：2026-03-01
> 审阅日期：2026-03-01
> 状态：已审阅

---

## 一、总体设计原则

| 原则 | 说明 |
|------|------|
| **最小侵入** | 优先修改已有函数，不新建模块，不改接口签名 |
| **向后兼容** | 所有 API 变更均为新增可选参数，不破坏现有调用方 |
| **测试先行** | 每个功能对应单元测试，覆盖率维持 85% 以上 |
| **数据隔离** | 新增表均含 `workspace_id` + `user_id`，通过 DAO 层隔离 |

---

## 二、各功能设计详情

---

### #51 Few-shot 示例库扩展

#### 改动文件

| 文件 | 操作 | 说明 |
|------|------|------|
| `lib/ai/prompts/prd-examples.ts` | 修改 | 新增 7 个示例 + 优化选择算法 |
| `tests/unit/prd-examples.test.ts` | 新增 | 示例选择的单元测试 |

#### 数据结构说明

**现有 `PRDExample` 接口**（定义在 `lib/ai/prompts/prd-system.ts`，由 `prd-examples.ts` import）：

```typescript
// 当前接口（不做任何修改）
interface PRDExample {
  userInput: string                        // 用户输入描述
  context: string                          // 背景/RAG 上下文
  prdOutput: string                        // 标准 PRD 输出
  category: 'feature' | 'optimization'    // 严格枚举，只有这两个值
}
```

> ⚠️ **重要**：`category` 是严格枚举 `'feature' | 'optimization'`，**不能**扩展为行业标签。现有接口中**没有** `keywords` 字段。**不修改 `PRDExample` 接口**，行业匹配完全基于 `userInput` 文本内容。

#### 新增示例列表

新增 7 个示例，`category` 全部取 `'feature'`（均为功能类需求），行业识别通过 `userInput` 文字内容体现：

```typescript
// 示例 userInput 需包含行业关键词（如"SaaS 企业"、"在线学习"、"健康 App"等）
// 以便三维匹配算法能通过文本匹配区分行业
const NEW_EXAMPLES: PRDExample[] = [
  { category: 'feature', userInput: '为 SaaS 企业系统设计 RBAC 权限管理功能...',   /* #04 */ },
  { category: 'feature', userInput: '为在线学习平台设计学习进度追踪与证书发放...', /* #05 */ },
  { category: 'feature', userInput: '为健康 App 设计用户健康数据看板与预警...',    /* #06 */ },
  { category: 'feature', userInput: '为个人记账 App 设计账单分析与智能分类...',   /* #07 */ },
  { category: 'feature', userInput: '为内容社区设计创作者激励体系（打赏/分成）...', /* #08 */ },
  { category: 'feature', userInput: '为工具软件设计数据导入导出与批量操作功能...', /* #09 */ },
  { category: 'feature', userInput: '为政务/企业内部系统设计审批流程引擎...',      /* #10 */ },
]
```

#### 选择算法优化

**现有实现**（`selectRelevantExamples()`）：按 `category` 枚举做类别加分 + `extractKeywords()` 做关键词 Jaccard，按综合分排序。

**优化为三维匹配**（**不修改 `PRDExample` 接口**，所有匹配均基于文本）：

```
维度 1：行业关键词匹配（权重 0.5）
  - 预定义行业词表：SaaS/B2B、教育/学习、医疗/健康、金融/记账、社区/创作者、工具/效率、政务/审批
  - 同时在 userInput（用户输入）和 example.userInput（示例输入）中检测行业词
  - 两者命中同一行业则得满分 1，否则得 0

维度 2：功能动词匹配（权重 0.3）
  - 预定义功能词表：管理、分析、追踪、激励、导出、审批、看板、证书、权限
  - 计算两者功能词集合的命中数占比（0..1）

维度 3：文本 Jaccard 相似度（权重 0.2）
  - extractKeywords(userInput) ∩ extractKeywords(example.userInput) 的 Jaccard 系��
  - 无需 embedding，纯词集合计算，零外部依赖
```

**伪代码**：

```typescript
function selectRelevantExamples(userInput: string, count = 2): PRDExample[] {
  const allExamples = PRD_EXAMPLES  // 现有 3 个 + 新增 7 个 = 10 个

  return allExamples
    .map(ex => ({ ex, score: computeMatchScore(userInput, ex) }))
    .sort((a, b) => b.score - a.score)
    .slice(0, count)
    .map(({ ex }) => ex)
}

function computeMatchScore(userInput: string, ex: PRDExample): number {
  const dim1 = industryKeywordMatch(userInput, ex.userInput)  // 0 or 1
  const dim2 = functionKeywordMatch(userInput, ex.userInput)  // 0..1
  const dim3 = jaccardSimilarity(userInput, ex.userInput)     // 0..1
  return dim1 * 0.5 + dim2 * 0.3 + dim3 * 0.2
}
```

---

### #52 语义感知上下文压缩

#### 改动文件

| 文件 | 操作 | 说明 |
|------|------|------|
| `lib/prd/generator.ts` | 修改 | 改写 `compressContext()` + `allocateTokenBudget()` |
| `tests/unit/prd-generator.test.ts` | 修改 | 新增压缩场景测试用例 |

#### 实现设计

**函数签名不变**，只改内部实现：

```typescript
// 现有签名（lib/prd/generator.ts），保持不变
private compressContext(context: string, maxTokens: number = 4000): string
private allocateTokenBudget(options?: PRDGenerationOptions): { systemPrompt, examples, context, userInput, output }
```

**`allocateTokenBudget()` 变更**（字段名与实际代码一致，`examples` 非 `fewShot`）：

```typescript
// 修改前
{ systemPrompt: 1500, examples: 2000, context: 4000, userInput: 500, output: maxTokens }

// 修改后
{ systemPrompt: 1500, examples: 1500, context: 5000, userInput: 500, output: maxTokens }
//                              ↑ 减少 500              ↑ 增加 1000
```

**`compressContext()` 新实现流程**：

```
步骤 1：按 Markdown 标题（##、###）拆分语义段落
  - 正则：/^#{2,3}\s+.+$/m 作为段落边界
  - 每个段落 = { heading, body, score }

步骤 2：对每个段落打重要性分（0～1）
  - 标题含关键词（功能|需求|用户|目标|背景|场景）：+0.30
  - 正文含数字/指标（\d+%?|KPI|指标|目标值）：+0.20
  - 正文长度 100~500 字：+0.10
  - 满分上限 1.0

步骤 3：按分数降序选段落，累积 token 数直到达到预算
  - token 估算：text.length / 1.5（中文平均字/token 比）

步骤 4：将选中段落按原文顺序重新排列，用 \n\n---\n\n 拼接输出
```

**边界处理**：
- 若拆不出任何标题（纯文本），退化为现有简单截取策略
- 单段超预算时：截取前 `maxTokens * 1.5` 字符，追加 `\n...[内容过长已截取]`

---

### #53 PRD 质量自评维度扩展

#### 改动文件

| 文件 | 操作 | 说明 |
|------|------|------|
| `lib/prd/refinement-engine.ts` | 修改 | 新增 2 维度 + 调整权重 + 下调阈值 |
| `tests/unit/refinement-engine.test.ts` | 修改 | 新增维度解析测试 |

#### 接口变更

**`PRDQualityCheck` 接口新增字段**（向后兼容）：

```typescript
interface PRDQualityCheck {
  completeness: number        // 权重 25%（原 30%）
  specificity: number         // 权重 20%（原 25%）
  logicalConsistency: number  // 权重 15%（原 25%）
  kpiQuality: number          // 权重 10%（原 20%）
  feasibility: number         // 权重 15% ← 新增
  userFocus: number           // 权重 15% ← 新增
  averageScore: number        // 加权平均分
  issues: QualityIssue[]
}
```

**AI Prompt 新增评估指令**（追加到现有 prompt 末尾，不替换）：

```
新增维度 5 - 可行性（feasibility，0-1分）：
  评估标准：技术方案是否脱离实际？实施计划时间线是否合理？资源需求是否有估算？
  当分数 < 0.6 时，在 issues 中说明具体问题（如"时间线过于激进"或"未说明技术实现方案"）

新增维度 6 - 用户视角（userFocus，0-1分）：
  评估标准：用户故事是否从真实场景出发？功能描述是否从用户利益而非技术角度阐述？
```

**质量阈值调整**：

```typescript
// lib/prd/refinement-engine.ts
// RefinementOptions.qualityThreshold 的默认值从 0.85 下调为 0.80
// 改动位置：evaluateQuality() 内判断是否触发迭代的条件判断处

// 修改前（当前代码中 qualityThreshold 默认为 0.85，通过 options?.qualityThreshold ?? 0.85 引用）
const threshold = options?.qualityThreshold ?? 0.85

// 修改后
const threshold = options?.qualityThreshold ?? 0.80
```

> **注意**：`RefinementOptions.qualityThreshold` 字段本身已存在（见接口定义），这里只改**默认值**（从 `0.85` 改为 `0.80`），不新增字段。

**加权计算逻辑**：

```typescript
function computeAverageScore(check: PRDQualityCheck): number {
  return (
    check.completeness      * 0.25 +
    check.specificity       * 0.20 +
    check.logicalConsistency * 0.15 +
    check.kpiQuality        * 0.10 +
    check.feasibility       * 0.15 +
    check.userFocus         * 0.15
  )
}
```

---

### #54 PRD 用户反馈打分机制

#### 改动文件

| 文件 | 操作 | 说明 |
|------|------|------|
| `lib/db/schema.ts` | 修改 | 新增 `prd_feedbacks` 表定义 |
| `lib/db/dao/prd-feedback-dao.ts` | 新增 | PRD 反馈 DAO |
| `server/api/v1/prd/[id]/feedback.post.ts` | 新增 | 提交/更新反馈（upsert） |
| `server/api/v1/prd/[id]/feedback.get.ts` | 新增 | 获取当前用户反馈 |
| `server/api/v1/stats/prd-quality.get.ts` | 新增 | PRD 质量统计 |
| `migrations/add-prd-feedbacks.sql` | 新增 | 数据库迁移脚本 |
| `components/prd/FeedbackPanel.vue` | 新增 | 打分组件 |
| `pages/projects/[id].vue` | 修改 | 底部引入 FeedbackPanel |

#### 数据库设计

```sql
-- migrations/add-prd-feedbacks.sql
CREATE TABLE prd_feedbacks (
  id          UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  prd_id      UUID NOT NULL REFERENCES prd_documents(id) ON DELETE CASCADE,
  user_id     UUID NOT NULL REFERENCES users(id),
  rating      SMALLINT NOT NULL CHECK (rating BETWEEN 1 AND 5),
  positives   TEXT[],
  negatives   TEXT[],
  comment     TEXT,
  created_at  TIMESTAMPTZ DEFAULT NOW(),
  updated_at  TIMESTAMPTZ DEFAULT NOW(),
  UNIQUE(prd_id, user_id)
);

CREATE INDEX idx_prd_feedbacks_prd_id ON prd_feedbacks(prd_id);
CREATE INDEX idx_prd_feedbacks_user_id ON prd_feedbacks(user_id);
```

#### DAO 设计

```typescript
// lib/db/dao/prd-feedback-dao.ts
interface CreateFeedbackInput {
  prdId: string
  userId: string
  rating: number           // 1-5
  positives?: string[]     // 好的方面标签
  negatives?: string[]     // 需改进标签
  comment?: string
}

class PRDFeedbackDAO {
  // upsert：同一用户重复提交时更新
  async upsert(input: CreateFeedbackInput): Promise<PRDFeedback>
  async findByPrdAndUser(prdId: string, userId: string): Promise<PRDFeedback | null>
  async getQualityStats(workspaceId: string, days?: number): Promise<QualityStats>
}
```

#### API 设计

**POST `/api/v1/prd/:id/feedback`**

```typescript
// 请求 Zod Schema
const FeedbackSchema = z.object({
  rating: z.number().int().min(1).max(5),
  positives: z.array(z.string()).optional(),
  negatives: z.array(z.string()).optional(),
  comment: z.string().max(500).optional()
})

// 响应
{ success: true, data: { id, prdId, rating, positives, negatives, createdAt } }
```

**GET `/api/v1/prd/:id/feedback`**

```typescript
// 响应（无反馈时返回 null）
{ success: true, data: PRDFeedback | null }
```

**GET `/api/v1/stats/prd-quality`**

```typescript
// Query 参数
interface QualityStatsQuery {
  workspaceId: string
  days?: number  // 默认 30
}

// 响应
{
  success: true,
  data: {
    averageRating: number,          // 平均分
    totalFeedbacks: number,
    ratingDistribution: Record<1|2|3|4|5, number>,
    topPositives: { label: string, count: number }[],
    topNegatives: { label: string, count: number }[]
  }
}
```

#### 前端组件设计

```
components/prd/FeedbackPanel.vue

Props:
  prdId: string

状态机：
  'idle'      → 未加载（初始）
  'unrated'   → 已加载，用户未评分
  'selecting' → 用户点击星级后，展开标签选择
  'submitting'→ 提交中
  'rated'     → 已提交，展示回显

标签常量（定义在组件内）：
  POSITIVE_TAGS = ['结构清晰', 'KPI 具体', '行业符合', '可直接使用']
  NEGATIVE_TAGS = ['内容空泛', '缺少数据支撑', '技术方案不实际', '需要大量修改']
```

---

### #55 原型多页面解析容错增强

#### 改动文件

| 文件 | 操作 | 说明 |
|------|------|------|
| `lib/prototype/generator.ts` | 修改 | 重构 `parseMultiPageOutput()` 为多层容错策略 |
| `tests/unit/prototype-generator.test.ts` | 修改 | 新增 4 种解析层级测试 |

#### 实现设计

**函数签名不变**：

```typescript
static parseMultiPageOutput(fullOutput: string): ParsedPrototypePage[]
```

**多层解析实现**：

```typescript
static parseMultiPageOutput(fullOutput: string): ParsedPrototypePage[] {
  // 层级 1：标准标记解析
  const result1 = tryParseByMarker(fullOutput)
  if (result1.length > 0) return result1

  console.warn('[Prototype] 层级1解析失败，降级到层级2（H1/Title）')

  // 层级 2：按 HTML 文档边界拆分
  const result2 = tryParseByHtmlBoundary(fullOutput)
  if (result2.length > 0) return result2

  console.warn('[Prototype] 层级2解析失败，降级到层级3（代码块）')

  // 层级 3：提取 ```html 代码块
  const result3 = tryParseByCodeBlock(fullOutput)
  if (result3.length > 0) return result3

  console.warn('[Prototype] 层级3解析失败，降级到层级4（兜底）')

  // 层级 4：整体作为单页面
  return fallbackSinglePage(fullOutput)
}
```

**各层实现要点**：

| 层级 | 核心逻辑 | 元数据补全规则 |
|------|---------|---------------|
| 层级 1 | 正则 `/<!--\s*PAGE\s*:\s*(\w[\w-]*)\s*:\s*(.+?)\s*-->/gi`（容错大小写/多余空格） | 从标记直接取 |
| 层级 2 | 按 `<!DOCTYPE html>` 或 `<html` 切分多个文档 | slug 取 `<title>` 转 kebab-case，名称取 `<h1>` 或 `<title>` |
| 层级 3 | 正则 `/```html\n([\s\S]*?)```/g` 提取代码块 | slug 生成 `page-{n}`，名称「页面 {n}」 |
| 层级 4 | 提取 `<!DOCTYPE...>` 到 `</html>` 之间内容 | slug `main`，名称「主页面」 |

---

### #56 原型设计主题/色系定制

#### 改动文件

| 文件 | 操作 | 说明 |
|------|------|------|
| `lib/prototype/prototype-system.ts` | 修改 | 参数化 `buildDesignSystem()`，接收主题配置 |
| `lib/prototype/generator.ts` | 修改 | `generateFromPRD()` 新增可选 `theme` 参数 |
| `server/api/v1/prototypes/generate-from-prd.post.ts` | 修改 | 请求体新增可选 `theme` 字段 |
| `components/prototype/GenerateDialog.vue` | 修改 | 新增主题选择行 |
| `types/prototype.ts` | 修改 | 新增 `ThemeConfig` 类型 |

#### 类型定义

```typescript
// types/prototype.ts

type ThemePreset = 'default' | 'tech' | 'nature' | 'energy' | 'pro' | 'custom'

interface ThemeConfig {
  preset: ThemePreset
  primaryColor?: string  // 仅 preset='custom' 时有效，格式 #RRGGBB
}

interface ThemeColors {
  primary: string       // 主色
  primaryLight: string  // 主色 +20% 亮度
  primaryDark: string   // 主色 -20% 亮度
}
```

**预设主题常量**：

```typescript
const THEME_PRESETS: Record<ThemePreset, ThemeColors> = {
  default: { primary: '#6366F1', primaryLight: '#818CF8', primaryDark: '#4F46E5' },
  tech:    { primary: '#2563EB', primaryLight: '#3B82F6', primaryDark: '#1D4ED8' },
  nature:  { primary: '#059669', primaryLight: '#10B981', primaryDark: '#047857' },
  energy:  { primary: '#EA580C', primaryLight: '#F97316', primaryDark: '#C2410C' },
  pro:     { primary: '#374151', primaryLight: '#6B7280', primaryDark: '#1F2937' },
  custom:  { primary: '#6366F1', primaryLight: '#818CF8', primaryDark: '#4F46E5' }, // 由 primaryColor 覆盖
}
```

#### `buildDesignSystem()` 改造

```typescript
// 现有（硬编码）
function buildDesignSystem(): string {
  return `Primary: #6366F1\n...`
}

// 优化后（参数化，向后兼容，不传 theme 时使用 default）
function buildDesignSystem(theme?: ThemeConfig): string {
  const colors = resolveThemeColors(theme)
  return `
## 设计系统
- Primary: ${colors.primary}
- Primary-light: ${colors.primaryLight}
- Primary-dark: ${colors.primaryDark}
  `
}
```

#### API 变更（向后兼容）

```typescript
// server/api/v1/prototypes/generate-from-prd.post.ts
const GenerateSchema = z.object({
  prdId: z.string().uuid(),
  modelId: z.string().optional(),
  temperature: z.number().optional(),
  maxTokens: z.number().int().optional(),
  pageCount: z.number().int().min(1).max(10).optional(),
  deviceType: z.enum(['desktop', 'mobile', 'tablet']).optional(),
  // 新增，完全可选
  theme: z.object({
    preset: z.enum(['default', 'tech', 'nature', 'energy', 'pro', 'custom']),
    primaryColor: z.string().regex(/^#[0-9A-Fa-f]{6}$/).optional()
  }).optional()
})
```

#### 前端 UI 设计

在生成原型 Dialog 的「页面数量」下方新增一行：

```
主题      ●默认紫  ○科技蓝  ○自然绿  ○活力橙  ○专业灰  ○自定义
          [色块]   [色块]   [色块]   [色块]   [色块]   [#______]
```

- 选中时色块带外边框高亮
- 选「自定义」时右侧出现 HEX 输入框，实时更新预览色块

---

### #57 原型交互 JS 模板库

#### 改动文件

| 文件 | 操作 | 说明 |
|------|------|------|
| `lib/prototype/prototype-system.ts` | 修改 | 在系统 prompt 的 JS 规范章节注入模板库 |
| `lib/prototype/js-templates.ts` | 新增 | 10 个 JS 模板定义（纯函数，无外部依赖） |
| `tests/unit/js-templates.test.ts` | 新增 | 每个模板的功能验证 |

#### 模板文件结构

```typescript
// lib/prototype/js-templates.ts

interface JSTemplate {
  name: string
  description: string
  code: string  // 完整内联 <script> 实现
}

export const JS_TEMPLATES: JSTemplate[] = [
  { name: 'modal',           description: '弹窗打开/关闭，ESC/遮罩关闭', code: `...` },
  { name: 'tabs',            description: 'Tab 切换，active 样式联动',    code: `...` },
  { name: 'dropdown',        description: '下拉菜单，点击外部关闭',        code: `...` },
  { name: 'form-validate',   description: '必填校验，错误提示',            code: `...` },
  { name: 'toast',           description: '3秒自动消失，success/error',   code: `...` },
  { name: 'accordion',       description: '手风琴折叠展开',                code: `...` },
  { name: 'sidebar-toggle',  description: '侧边栏折叠，移动端菜单',         code: `...` },
  { name: 'table-sort',      description: '表格列排序',                    code: `...` },
  { name: 'infinite-scroll', description: '滚动加载更多',                  code: `...` },
  { name: 'search-filter',   description: '输入框实时过滤列表',             code: `...` },
]

export function buildJSTemplatePrompt(): string {
  return JS_TEMPLATES
    .map(t => `### ${t.name}\n// ${t.description}\n${t.code}`)
    .join('\n\n')
}
```

#### 注入位置

在 `prototype-system.ts` 的系统提示词「JavaScript 规范」章节末尾追加：

```
## JavaScript 交互规范
以下是经过验证的标准交互实现，你必须直接使用这些实现，不要重新创造：

${buildJSTemplatePrompt()}

使用规则：
1. 需要模态框时，使用 modal 模板
2. 需要标签页时，使用 tabs 模板
3. 以此类推，优先复用已有模板
```

#### 模板设计约束

- 所有模板使用原生 DOM API，无框架依赖
- 使用 `data-*` 属性作为 JS 钩子，不依赖 class 名
- 每个模板自包含，互不干扰，可同页面共存

---

### #58 RAG 动态相似度阈值

#### 改动文件

| 文件 | 操作 | 说明 |
|------|------|------|
| `lib/rag/retriever.ts` | 修改 | 新增 `computeThreshold()` + 改造 `retrieve()` |
| `tests/unit/rag-retriever.test.ts` | 修改 | 新增阈值计算的 4 类测试用例 |

#### 接口变更（向后兼容）

**现有 `RetrievalOptions` 接口**（`lib/rag/retriever.ts`）：

```typescript
interface RetrievalOptions {
  topK?: number
  threshold?: number        // 已有字段：传入时直接使用，不走动态计算
  documentIds?: string[]
  prdIds?: string[]
  userId?: string
  ragStrategy?: 'hybrid' | 'vector'
}
```

**本次新增字段**：

```typescript
interface RetrievalOptions {
  // ...以上字段不变...
  thresholdOverride?: number        // 新增：与现有 threshold 语义相同，明确覆盖动态阈值
  workspaceThresholdOffset?: number // 新增：工作区级偏移量（-0.1 ~ +0.1），叠加在基准阈值上
  workspaceId?: string              // 新增：供 #59 日志写入使用
}
```

> **向后兼容策略**：现有代码传入 `threshold` 时继续生效；新增的 `thresholdOverride` 优先级最高，语义更明确。两者取一即可，建议新调用方用 `thresholdOverride`。

#### 动态阈值实现

```typescript
// lib/rag/retriever.ts 新增内部函数

function computeThreshold(query: string, baseOffset: number = 0): number {
  const tokenCount = query.length / 4  // 粗估 token 数

  let threshold = 0.70 + baseOffset    // 基准阈值 + 工作区级偏移

  if (tokenCount < 5) threshold -= 0.05    // 短查询：放宽
  if (tokenCount > 20) threshold += 0.05   // 长查询：收紧
  if (/\b[A-Z]{2,}\b/.test(query)) threshold += 0.03   // 含缩写：精确匹配
  if (/^[\u4e00-\u9fa5\s]+$/.test(query) && tokenCount < 10) threshold -= 0.03  // 纯中文短句

  return Math.min(Math.max(threshold, 0.55), 0.85)  // 限制在 [0.55, 0.85]
}
```

**`retrieve()` 中的阈值决策**：

```typescript
async retrieve(query: string, options: RetrievalOptions = {}): Promise<RetrievedChunk[]> {
  // 优先级：thresholdOverride > options.threshold > 动态计算
  const effectiveThreshold = options.thresholdOverride
    ?? options.threshold
    ?? computeThreshold(query, options.workspaceThresholdOffset ?? 0)

  // 在检索结果日志中记录实际使用的阈值
  console.debug(`[RAG] query="${query.slice(0, 30)}" threshold=${effectiveThreshold}`)

  // ...现有检索逻辑，用 effectiveThreshold 替代 0.7
}
```

#### 工作区级配置（可选，UI 在 #59 中实现）

工作区设置滑块（精准 ↔ 宽泛）映射为 `baseOffset`：

```
宽泛端（-0.1）← ─────── ── ─ ▸ 精准端（+0.1）
```

---

### #59 检索质量评估面板

#### 改动文件

| 文件 | 操作 | 说明 |
|------|------|------|
| `lib/db/schema.ts` | 修改 | 新增 `rag_retrieval_logs` 表 |
| `lib/db/dao/rag-retrieval-log-dao.ts` | 新增 | 检索日志 DAO |
| `lib/rag/retriever.ts` | 修改 | 检索完成后异步写日志 |
| `server/api/v1/stats/rag-retrieval.get.ts` | 新增 | 检索质量统计端点 |
| `migrations/add-rag-retrieval-logs.sql` | 新增 | 迁移脚本 |
| `pages/knowledge-base.vue` | 修改 | 新增「检索统计」Tab |
| `components/rag/RetrievalStats.vue` | 新增 | 统计面板组件 |

#### 数据库设计

```sql
-- migrations/add-rag-retrieval-logs.sql
CREATE TABLE rag_retrieval_logs (
  id                UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  workspace_id      UUID NOT NULL,
  user_id           UUID NOT NULL,
  query_hash        TEXT NOT NULL,          -- SHA-256 of query（不存明文）
  document_ids      UUID[],                 -- 被引用的文档 ID 列表
  similarity_scores FLOAT[],               -- 对应相似度分数
  strategy          TEXT,                  -- 'vector' | 'hybrid'
  threshold         FLOAT,                 -- 实际使用的阈值
  result_count      INTEGER,
  created_at        TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_rag_logs_workspace_created
  ON rag_retrieval_logs(workspace_id, created_at DESC);
CREATE INDEX idx_rag_logs_document_ids
  ON rag_retrieval_logs USING GIN(document_ids);
```

#### 异步日志写入

**关键约束：不阻塞主检索链路**

> ⚠️ **注意**：现有 `RetrievalOptions` 中没有 `workspaceId` 字段，日志写入时 `workspaceId` 需从上层调用者（API 路由）传入，而非从 `RetrievalOptions` 中取。实现方案：在 `RAGRetriever.retrieve()` 新增 `workspaceId` 可选参数，或通过 `RetrievalOptions` 扩展（与 #58 同步添加该字段）。

```typescript
// lib/rag/retriever.ts retrieve() 末尾

// 异步写日志（fire-and-forget，错误不影响主流程）
// workspaceId 通过 RetrievalOptions 扩展字段传入（#58 已新增）
setImmediate(async () => {
  try {
    await ragRetrievalLogDAO.insert({
      workspaceId: options?.workspaceId ?? null,   // 可为 null，前端展示时过滤
      userId: options?.userId ?? null,
      queryHash: sha256(query),
      documentIds: results.map(r => r.documentId),
      similarityScores: results.map(r => r.similarity),
      strategy: options?.ragStrategy ?? 'hybrid',
      threshold: effectiveThreshold,
      resultCount: results.length,
    })
  } catch (e) {
    console.warn('[RAG] 日志写入失败（不影响检索结果）', e)
  }
})
```

> **`#58` 接口同步**：`RetrievalOptions` 需新增 `workspaceId?: string`（与 `#58` 的 `workspaceThresholdOffset` 在同一次接口扩展中完成）。

#### API 设计

**GET `/api/v1/stats/rag-retrieval`**

```typescript
// Query 参数
const QuerySchema = z.object({
  workspaceId: z.string().uuid(),
  days: z.coerce.number().int().min(1).max(90).default(7)
})

// 响应
{
  success: true,
  data: {
    totalRetrievals: number,
    uniqueDocumentsCited: number,
    averageSimilarity: number,
    hitRate: number,             // result_count > 0 的比例
    topDocuments: {
      documentId: string,
      documentTitle: string,
      citationCount: number,
      averageSimilarity: number
    }[],
    zeroCitationDocuments: {     // 在时间范围内从未被引用的文档
      documentId: string,
      documentTitle: string
    }[]
  }
}
```

---

### #60 Webhook 前端管理页面

#### 改动文件

| 文件 | 操作 | 说明 |
|------|------|------|
| `pages/workspace/[id]/settings.vue` | 新增 | 工作区设置页面（含多 Tab） |
| `components/webhook/WebhookList.vue` | 新增 | Webhook 列表组件 |
| `components/webhook/WebhookFormDialog.vue` | 新增 | 创建/编辑 Dialog |
| `components/webhook/DeliveryHistorySheet.vue` | 新增 | 投递历史侧抽屉 |
| `components/WorkspaceSwitcher.vue` | 修改 | 下拉菜单新增「工作区设置」入口（⚠️ 不是 AppSidebar.vue） |
| `server/api/v1/workspaces/[id]/webhooks/[wid]/deliveries/[deliveryId]/redeliver.post.ts` | 新增 | 重新投递端点 |

#### 页面结构

```
pages/workspace/[id]/settings.vue

Tabs:
  - 常规          （占位，暂无内容）
  - Webhook 管理  ← 主要实现目标
  - 成员管理       （占位，后续扩展）
```

#### 路由设计

| 路由 | 页面 |
|------|------|
| `/workspace/:id/settings` | 工作区设置首页（默认 Webhook Tab） |

**「工作区设置」入口位置**：

实际工作区切换器（`WorkspaceSwitcher`）位于 **`pages/app.vue`** 顶部 Header 区域，不在 `AppSidebar.vue` 内（侧边栏只有「项目」和「知识库」两个菜单项）。

入口应新增到 `WorkspaceSwitcher` 组件的下拉菜单中：

```
WorkspaceSwitcher 下拉菜单
  ├── [工作区名称]（当前工作区）
  ├── ──────────
  ├── 切换工作区...
  └── 工作区设置  ← 新增，跳转至 /workspace/:id/settings
```

改动文件：`components/WorkspaceSwitcher.vue`（或其所在组件），而非 `AppSidebar.vue`。

#### 组件设计

**WebhookList.vue**

```
Props: workspaceId: string
Events: —
内部状态: webhooks[], loading, selectedWebhook

列表列：URL | 订阅事件数 | 状态（Badge：启用/禁用）| 操作（编辑、删除、查看历史）
操作按钮：
  - 编辑 → 打开 WebhookFormDialog（传入 webhook 数据）
  - 删除 → AlertDialog 二次确认
  - 历史 → 打开 DeliveryHistorySheet（传入 webhookId）
右上角：[+ 新建 Webhook] → 打开空的 WebhookFormDialog
```

**WebhookFormDialog.vue**

```
Props: workspaceId, webhook?(编辑时传入)
Events: saved, close

表单字段（Zod 校验）：
  url:    z.string().url()（必填）
  secret: z.string().optional()
  events: z.array(z.string()).min(1)（多选 Checkbox）
  active: z.boolean().default(true)（Switch）

事件选项（来自后端 webhook-events 常量）：
  document.uploaded / document.completed / prd.generated /
  comment.created / member.joined

提交：POST（新建）或 PATCH（编辑），成功后 emit('saved')
```

**DeliveryHistorySheet.vue**

```
使用 Sheet 组件（非 Dialog，从右侧滑入）
Props: workspaceId, webhookId

列表列：时间 | 事件 | 状态码（Badge：2xx 绿色/其他红色）| 耗时

点击行 → 展开/收起：
  请求体（JSON 格式化展示，用 <pre> + overflow-auto）
  响应体

底部固定：[重新投递] 按钮（调用 redeliver 端点，成功后 toast 提示）
```

#### 重新投递端点设计

```typescript
// POST /api/v1/workspaces/:id/webhooks/:wid/deliveries/:deliveryId/redeliver
// 无请求体

export default defineEventHandler(async (event) => {
  const userId = requireAuth(event)
  const { id: workspaceId, wid: webhookId, deliveryId } = getRouterParams(event)

  // 1. 校验用户是工作区成员且有权限
  // 2. 查询原始 delivery 记录
  // 3. 重新向 webhook.url 发送相同的 payload
  // 4. 记录新的 delivery 日志（is_redeliver = true）
  // 5. 返回新的 delivery 记录

  return { success: true, data: newDelivery }
})
```

---

### #61 PRD 多版本对比查看

#### 改动文件

| 文件 | 操作 | 说明 |
|------|------|------|
| `pages/prd-compare.vue` | 新增 | 对比页面（接收 query 参数 `?a=:id&b=:id`） |
| `pages/app.vue` | 修改 | PRD 列表页新增「对比模式」入口（⚠️ PRD 列表在 app.vue，不是 generate.vue） |
| `components/prd/ComparePanel.vue` | 新增 | 对比面板组件 |
| `package.json` | 修改 | 新增 `diff-match-patch` 依赖 |

#### 依赖安装

```bash
pnpm add diff-match-patch
pnpm add -D @types/diff-match-patch
```

#### 对比页面路由

```
/prd-compare?a=<prd_id_a>&b=<prd_id_b>
```

#### 算法设计

**段落级 Diff（非逐字符）**：

```typescript
// components/prd/ComparePanel.vue
import { diff_match_patch } from 'diff-match-patch'

function comparePRDs(contentA: string, contentB: string): DiffSection[] {
  // 1. 将两个 PRD 内容按 Markdown 章节（## 标题）拆分为段落数组
  const sectionsA = splitByHeadings(contentA)
  const sectionsB = splitByHeadings(contentB)

  // 2. 对每个同名章节内部做精细 diff（使用 diff-match-patch）
  // 3. 对不同的章节整段标记为新增/删除
  // 4. 返回带差异标记的段落列表
}

interface DiffSection {
  heading: string
  status: 'same' | 'modified' | 'added' | 'removed'
  diffHtml?: string  // 仅 modified 时有值，包含高亮 HTML
}
```

#### UI 布局

```
左右各 50% 分栏
左栏：PRD A（标题、生成时间）
右栏：PRD B（标题、生成时间）

差异高亮：
  绿色背景 (#dcfce7) → 右侧新增内容
  红色背景 (#fee2e2) → 左侧删除内容

同步滚动：监听 scroll 事件，两侧同步 scrollTop
```

---

## 三、数据库变更汇总

| Issue | 迁移文件 | 表名 | 变更类型 |
|-------|---------|------|---------|
| #54 | `migrations/add-prd-feedbacks.sql` | `prd_feedbacks` | 新增表 |
| #59 | `migrations/add-rag-retrieval-logs.sql` | `rag_retrieval_logs` | 新增表 |

---

## 四、API 变更汇总

| Issue | 方法 | 路径 | 类型 |
|-------|------|------|------|
| #54 | POST | `/api/v1/prd/:id/feedback` | 新增端点 |
| #54 | GET  | `/api/v1/prd/:id/feedback` | 新增端点 |
| #54 | GET  | `/api/v1/stats/prd-quality` | 新增端点 |
| #56 | POST | `/api/v1/prototypes/generate-from-prd` | 新增可选字段 `theme` |
| #59 | GET  | `/api/v1/stats/rag-retrieval` | 新增端点 |
| #60 | POST | `/api/v1/workspaces/:id/webhooks/:wid/deliveries/:deliveryId/redeliver` | 新增端点 |

---

## 五、新增文件清单

```
lib/
├── prototype/
│   └── js-templates.ts               # #57 JS 模板库
├── db/dao/
│   ├── prd-feedback-dao.ts           # #54 PRD 反馈 DAO
│   └── rag-retrieval-log-dao.ts      # #59 检索日志 DAO

server/api/v1/
├── prd/[id]/
│   ├── feedback.post.ts              # #54
│   └── feedback.get.ts               # #54
├── stats/
│   ├── prd-quality.get.ts            # #54
│   └── rag-retrieval.get.ts          # #59
└── workspaces/[id]/webhooks/[wid]/deliveries/[deliveryId]/
    └── redeliver.post.ts             # #60

migrations/
├── add-prd-feedbacks.sql             # #54
└── add-rag-retrieval-logs.sql        # #59

pages/
├── workspace/[id]/settings.vue       # #60
└── prd-compare.vue                   # #61

components/
├── prd/
│   ├── FeedbackPanel.vue             # #54
│   └── ComparePanel.vue              # #61
├── rag/
│   └── RetrievalStats.vue            # #59
└── webhook/
    ├── WebhookList.vue               # #60
    ├── WebhookFormDialog.vue          # #60
    └── DeliveryHistorySheet.vue       # #60

# 修改已有文件（不在新增清单，但需记录）
components/WorkspaceSwitcher.vue       # #60 新增「工作区设置」菜单项

tests/unit/
├── prd-examples.test.ts              # #51（修改）
├── prd-generator.test.ts             # #52（修改）
├── refinement-engine.test.ts         # #53（修改）
├── prototype-generator.test.ts       # #55（修改）
├── rag-retriever.test.ts             # #58（修改）
└── js-templates.test.ts              # #57（新增）
```

---

## 六、开发顺序与分支规划

按需求文档建议的三阶段顺序，每个 Issue 一个功能分支：

| 阶段 | Issue | 分支名 | 依赖 |
|------|-------|--------|------|
| 第一阶段 | #52 | `feature/52-semantic-context-compress` | 无 |
| 第一阶段 | #51 | `feature/51-fewshot-examples-expand` | 无 |
| 第一阶段 | #57 | `feature/57-prototype-js-templates` | 无 |
| 第一阶段 | #55 | `feature/55-prototype-parse-fallback` | 无 |
| 第一阶段 | #58 | `feature/58-rag-dynamic-threshold` | 无 |
| 第二阶段 | #53 | `feature/53-prd-quality-dimensions` | #52 |
| 第二阶段 | #54 | `feature/54-prd-feedback` | 无 |
| 第二阶段 | #59 | `feature/59-rag-retrieval-panel` | #58 |
| 第三阶段 | #56 | `feature/56-prototype-theme` | #57 |
| 第三阶段 | #60 | `feature/60-webhook-frontend` | 无 |
| 第三阶段 | #61 | `feature/61-prd-compare` | 无 |

所有分支从 `develop` 切出，PR 目标为 `develop`。

---

## 七、测试策略

| 功能 | 单元测试重点 |
|------|------------|
| #51 | 10 个示例中，各行业关键词能命中对应示例；Jaccard 相似度计算正确 |
| #52 | 全量上下文（无需压缩）、超预算压缩（保留高分段落）、仅有一段的边界情况 |
| #53 | 新维度解析正确；`feasibility < 0.6` 时 issues 非空；加权平均计算正确 |
| #54 | upsert 语义（同用户重复提交变更新）；rating 越界拒绝 |
| #55 | 4 种降级路径各独立测试；容错标记（大小写/空格）；slug/名称补全 |
| #57 | 每个模板在 JSDOM 环境中功能验证（modal 打开关闭、tab 切换等） |
| #58 | 短查询（< 5 token）阈值 < 0.70；长查询（> 20 token）阈值 > 0.70；纯中文短句；含缩写 |
| #59 | 异步日志写入不阻塞检索返回（计时断言） |

---

## 八、验收清单

### P0 功能（版本必做）

- [ ] #51：10+ 示例，行业关键词命中率测试通过
- [ ] #52：压缩后无截断句子，高分段落优先保留
- [ ] #55：4 种解析层级单元测试全通过
- [ ] #57：10 个 JS 模板经人工验证，交互功能正确
- [ ] #58：动态阈值单元测试覆盖 4 种查询类型

### P1 功能（强烈建议）

- [ ] #53：6 维度权重之和 = 1.0，阈值下调至 0.80
- [ ] #54：FeedbackPanel 展示正常，upsert 正确，数据库迁移已验证
- [ ] #56：6 种主题可选，自定义 HEX 验证，生成的 HTML 颜色正确
- [ ] #60：Webhook 列表/创建/编辑/删除/历史均可用，redeliver 端点正常

### P2 功能（视进度）

- [ ] #59：检索统计面板数据准确，零引用文档列出
- [ ] #61：对比页面左右同步滚动，差异高亮正确

### 通用验收

- [ ] `pnpm lint` 通过
- [ ] `pnpm typecheck` 通过
- [ ] `pnpm test` 通过，覆盖率 ≥ 85%
- [ ] 所有新增 API 端点有 Zod 校验
- [ ] 所有 UI 使用 shadcn/ui，无浏览器原生弹窗

---

---

## 九、设计文档审阅记录（v1.0 → v1.1）

以下为对初稿（v1.0）的审阅修订，均基于实际代码比对。

| 类别 | 问题 | 修订内容 |
|------|------|----------|
| **接口认知错误** | #51 将 `PRDExample.category` 描述为可扩展字符串，并新增了不存在的 `keywords` 字段 | 已更正：`category` 是严格枚举 `'feature'\|'optimization'`，不修改接口；行业匹配全部基于 `userInput` 文本 |
| **接口认知错误** | #51 算法维度 1、2 引用 `ex.category`（枚举）和 `ex.keywords`（不存在字段） | 已更正：两个维度均改为与 `ex.userInput` 做文本关键词比对 |
| **字段名错误** | #52 `allocateTokenBudget()` 的返回对象写作 `{ ragContext, fewShot, ... }`，与实际代码字段名（`context`、`examples`）不符 | 已更正为实际字段名，并以「修改前/后」对比格式呈现 |
| **函数签名错误** | #52 `compressContext()` 默认参数写为无默认值，实际代码默认 `maxTokens=4000` | 已补充默认值 |
| **变量位置错误** | #53 质量阈值描述为"修改 `QUALITY_THRESHOLD` 常量"，实际代码无此常量，阈值通过 `options?.qualityThreshold ?? 0.85` 读取 | 已更正为修改 `?? 0.85` 处的默认值，并说明 `RefinementOptions.qualityThreshold` 字段本身不需新增 |
| **字段未声明** | #58 `retrieve()` 中引用 `options.workspaceThresholdOffset` 但接口未扩展该字段 | 已在接口变更表中补充声明 |
| **字段未声明** | #59 日志写入引用 `options.workspaceId` 但现有 `RetrievalOptions` 无此字段 | 已说明需通过 #58 的接口扩展同步新增 `workspaceId?: string`，并在 #58 接口定义中补充 |
| **组件路径错误** | #60 将「工作区设置」入口描述为修改 `AppSidebar.vue`，实际工作区切换器在 `pages/app.vue` 引用的 `WorkspaceSwitcher.vue` 中 | 已更正改动文件为 `components/WorkspaceSwitcher.vue` |
| **页面路径错误** | #61 将 PRD 列表入口写为"pages/generate.vue 或 PRD 列表页"，实际 PRD 列表在 `pages/app.vue` 中 | 已更正为 `pages/app.vue` |

---

*文档版本：v1.1 | 创建日期：2026-03-01 | 审阅日期：2026-03-01 | 负责人：ArchMind Team*
